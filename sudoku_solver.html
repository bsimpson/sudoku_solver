<html>
<title>Sudoku Solver</title>
<script type="text/javascript">

  function createTile(row_id, column_id) {
    var el = document.createElement('input');
    el.setAttribute('data-row', row_id);
    el.setAttribute('data-column', column_id);
    el.setAttribute('size', 1);
    return el;
  }

  function drawGrid() {
    var body = document.getElementsByTagName('form')[0];
    var options = {};
    for (var x=1; x < 10; x++) {
      for (var y=1; y < 10; y++) {
        body.appendChild(createTile(x, y));
      }
      body.appendChild(document.createElement('div'));
    }
  }

  var tries = 0;


  function solve() {
    tries++;
    console.log('solving - pass: ' + tries);
    for (var x=1; x < 10; x++) {
      for (var y=1; y < 10; y++) {
        var input = getElementByRowAndColumn(x,y);

        if (input.value == "") {
	  calculateByRowColumnAndQuadrant(x,y);
          calculateByInferrence(x,y);
        }
      }
    }

    // recursion
    var collection = document.getElementsByTagName('input');
    var values = [];
    for (var x=0; x < collection.length; x++) {
      values.push(collection[x].value);
    }
    if (values.indexOf("") != -1) {
      if (tries < 10) {
        setTimeout(solve, 500); 
      } else {
        tries = 0;
      }
    }
  }

  function calculateByRowColumnAndQuadrant(row, column) {
    var pool = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];
    var known = [];

    var rowValues = valuesFromRow(row);
    for (var z=0; z < rowValues.length; z++) {
      known.push(rowValues[z]);
    }

    var columnValues = valuesFromColumn(column);
    for (var z=0; z < columnValues.length; z++) {
       known.push(columnValues[z]);
    }

    var quadrantValues = valuesFromQuadrant(row,column);
    for (var z=0; z < quadrantValues.length; z++) {
      known.push(quadrantValues[z]);
    }

    // TODO uniq
          
    // Remove known numbers from the pool
    for (var z=0; z < known.length; z++) {
      var position = pool.indexOf(known[z]);
      if (position != -1) {
        pool.splice(position, 1);
      }
    }


    if (pool.length == 1) {
      // solvable
      getElementByRowAndColumn(row, column).value = pool[0];
    }
  }

  function calculateByInferrence(row, column) {
    var rows = [], columns = [], quadrant = [];
    if (row <= 3) {
      rows = [1,2,3];
    } else if ( row > 3 && row <= 6) {
      rows = [4,5,6];
    } else if ( row > 6) {
      rows = [7,8,9];
    }

    if (column <=3) {
      columns = [1,2,3];
    } else if (column > 3 && column <= 6) {
      columns = [4,5,6];
    } else if (column > 6) {
      columns = [7,8,9];
    }

    for (row in rows) {
      for (column in columns) {
        var x = rows[row];
        var y = columns[column];

        if (getElementByRowAndColumn(x,y).value == "") {
          
          var pool = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];
          var known = [];
          var rowValues = valuesFromRow(x);
          for (var z=0; z < rowValues.length; z++) {
            known.push(rowValues[z]);
          }

          var columnValues = valuesFromColumn(y);
          for (var z=0; z < columnValues.length; z++) {
             known.push(columnValues[z]);
          }

          var quadrantValues = valuesFromQuadrant(x,y);
          for (var z=0; z < quadrantValues.length; z++) {
            known.push(quadrantValues[z]);
          }

          // TODO uniq
          
          // Remove known numbers from the pool
          for (var z=0; z < known.length; z++) {
            var position = pool.indexOf(known[z]);
            if (position != -1) {
              pool.splice(position, 1);
            }
          }

          // pool populated with options
          quadrant.push([x, y, pool]);

        } // if
      }
    }

    // quadrant is populated, see what numbers in each pool are unique
    populateTilesWithDistinctResults(quadrant);
  }

  // quadrant is [row, column, [values]]
  function populateTilesWithDistinctResults(quadrant){
    var mapOfValues = [];

    for (tile in quadrant) {
      for (value in quadrant[tile][2]) {
        mapOfValues.push(quadrant[tile][2][value]);
      }
    }

    var countFrequency = {"1":0, "2":0, "3":0, "4":0, "5":0, "6":0, "7":0, "8":0, "9":0};
    for (number in mapOfValues) {
      countFrequency[mapOfValues[number]]++;
    }

    for (key in countFrequency) {
      if (countFrequency[key] == 1) {
        for (tile in quadrant) {
          if (quadrant[tile][2].indexOf(key) != -1) {
            getElementByRowAndColumn(quadrant[tile][0], quadrant[tile][1]).value = key;
          }
        }
      }
    }
  }

  function getElementByRowAndColumn(row_id, column_id) {
    var collection = document.getElementsByTagName('input');
    for (var y=0; y < collection.length; y++) {
      var attributes = {};
      for (var x=0; x < collection[y].attributes.length; x++) {
        attributes[collection[y].attributes[x].name] = collection[y].attributes[x].value;
      }
      if ((attributes['data-row'] == row_id) && (attributes['data-column'] == column_id)) {
        return collection[y];
      }
    }
  }

  function getValuesFromInputs(collection) {
    var results = [];
    for (var x=0; x < collection.length; x++) {
      if (collection[x] != undefined) {
        var value = collection[x].value;
        if (value && value != "") {
          results.push(value);
        }
      }
    }
    return results;
  }

  function valuesFromRow(row) {
    var collection = [];
    for (var x=1; x < 10; x++) {
      collection.push(getElementByRowAndColumn(row, x));
    }
    return getValuesFromInputs(collection);
  }

  function valuesFromColumn(column) {
    var collection = [];
    for (var x=1; x < 10; x++) {
      collection.push(getElementByRowAndColumn(x, column));
    }
    return getValuesFromInputs(collection);
  }

  function valuesFromQuadrant(row, column) {
    var rows = [], columns = [], collection = [];
    if (row <= 3) {
      rows = [1,2,3];
    } else if ( row > 3 && row <= 6) {
      rows = [4,5,6];
    } else if ( row > 6) {
      rows = [7,8,9];
    }

    if (column <=3) {
      columns = [1,2,3];
    } else if (column > 3 && column <= 6) {
      columns = [4,5,6];
    } else if (column > 6) {
      columns = [7,8,9];
    }

    for (var x=0; x < rows.length; x++) {
      for (var y=0; y < columns.length; y++) {
        collection.push(getElementByRowAndColumn(rows[x], columns[y]));
      }
    }

    return getValuesFromInputs(collection);
  }

  function setListeners() {
    document.getElementById('submit').addEventListener('click', solve);
    document.getElementById('populate').addEventListener('click', populate);
  }

  function populate() {
    // "Easy"
    var seed = [
	[1,2,5],
	[1,7,4],
	[2,3,6],
	[2,5,4],
	[2,7,1],
	[2,9,2],
	[3,1,2],
	[3,2,7],
	[3,4,5],
	[3,9,6],
	[4,3,5],
	[4,5,3],
	[4,9,8],
	[5,1,8],
	[5,2,2],
	[5,8,1],
	[5,9,4],
	[6,1,4],
	[6,5,7],
	[6,7,5],
	[7,1,3],
	[7,6,4],
	[7,8,8],
	[7,9,1],
	[8,1,7],
	[8,3,1],
	[8,5,6],
	[8,7,9],
	[9,3,2],
	[9,8,7]
    ];

    for (var x=0; x < seed.length; x++) {
      getElementByRowAndColumn(seed[x][0], seed[x][1]).value = seed[x][2];
    }
  }

  function populateExtreme() {
    var seed = [
	[1,1,7],
	[1,3,1],
	[1,5,6],
	[1,9,3],
	[3,1,3],
	[3,2,2],
	[3,6,8],
	[3,7,6],
	[3,8,1],
	[4,1,2],
	[4,4,3],
	[4,5,9],
	[4,7,7],
	[6,3,5],
	[6,5,4],
	[6,6,7],
	[6,9,2],
	[7,2,5],
	[7,3,9],
	[7,4,2],
	[7,8,3],
	[7,9,1],
	[9,1,6],
	[9,5,1],
	[9,7,5],
	[9,9,4]
    ];

    for (var x=0; x < seed.length; x++) {
      getElementByRowAndColumn(seed[x][0], seed[x][1]).value = seed[x][2];
      getElementByRowAndColumn(seed[x][0], seed[x][1]).setAttribute('style','background-color: yellow');
    }
  }

  window.onload = function() { 
    drawGrid();
    setListeners();
  };
</script>
<body>
  <form>
  </form>
  <input type="button" value="Populate" id="populate" />
  <input type="button" value="Solve It!" id="submit" />
</body>
</html>
